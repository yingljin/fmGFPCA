---
title: "Simulation"
author: "Ying Jin"
date: "`r Sys.Date()`"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

set.seed(625)

library(tidyverse)
library(here)

load(here("Data/Sim_J3.RData"))



```

# Simulation set-up

This file documents the simulation scheme of multi-level functional data. 

- Sample size: training = 100, test = 100
- Number of visits J = 3
- Number of observations at each vitis K = 100
- Make prediction with observations until the middle of visit 1, 2, 3 separately
- 100 simulations



- Binary outcomes: 

$$Y_{ij}(t) \sim Bernoulli(g(\eta_{ij}(t)))$$

$$\eta_{ij}(t)=b_0(t)+\sum_{l=1}^4\xi_{il}\phi_l(t)+\sum_{m=1}^4\zeta_{ijm}\psi_m(t)$$


- Level 1: 

$$\phi_l(t) = \{\sqrt{2}sin(2\pi t), \sqrt2 cos(2\pi t), \sqrt2 sin (4\pi t), \sqrt2 cos(4\pi t)\}$$

$$\xi_{il} \sim N(0, \lambda_l), \hspace{0.5cm} \lambda_l = 0.5^{l-1}, l=1,2, 3, 4$$

# Results

## Observed until midpoint of the 3rd visit

```{r}
pred_list_allM[[1]] %>%
  filter(visit == 3 & id %in% 101:104) %>% 
  mutate(eta_pred = ifelse(t<=0.5, NA, eta_pred)) %>% 
  mutate(eta_pred = exp(eta_pred)/(1+exp(eta_pred))) %>% 
  ggplot()+
  geom_line(aes(x=t, y=probs, col="True"))+
  geom_line(aes(x=t, y=eta_pred, col = "Prediction"), linetype="dashed", 
            na.rm = T)+
  geom_point(aes(x=t, y=Y), size = 0.5)+
  facet_grid(row = vars(id))
```

```{r}
print("fitting time (min):")
mean(fit_time_vec)
print("prediction time (min):")
mean(pred_time_vec)
```

```{r, message=FALSE}
print("integrated squared error")
bind_rows(pred_list_allM, .id = "iter") %>% 
  filter(visit==3 & t> 0.5) %>%
  group_by(iter, id) %>% 
  mutate(error = (eta_pred-eta)^2) %>%
  summarise(error = sum(error)) %>% 
  group_by(iter) %>% 
  summarize(error = mean(error)) %>% 
  summarize(error = mean(error), .groups = "drop")
```

