---
title: "Simulation"
author: "Ying Jin"
date: "`r Sys.Date()`"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

set.seed(625)

library(tidyverse)
library(here)
library(kableExtra)

load(here("Data/SimOutput/SimOutput_J200.RData"))
load(here("Data/SimOutput/SimOutput_J200_ref.RData"))


# valid_id <- which(pred_time_vec<=10)

```

# Simulation set-up

This file documents the simulation scheme of multi-level functional data. 

- Sample size: training = 100, test = 100
- Number of visits J = 3
- Number of observations at each vitis K = 200 (when K = 100, numeric issues are likely to happen)
- Make prediction with observations until the middle of visit 2 and 3 separately
- 100 simulations



- Binary outcomes: 

$$Y_{ij}(t) \sim Bernoulli(g(\eta_{ij}(t)))$$

$$\eta_{ij}(t)=b_0(t)+\sum_{l=1}^4\xi_{il}\phi_l(t)+\sum_{m=1}^4\zeta_{ijm}\psi_m(t)$$


- Level 1: 

$$\phi_l(t) = \{\sqrt{2}sin(2\pi t), \sqrt2 cos(2\pi t), \sqrt2 sin (4\pi t), \sqrt2 cos(4\pi t)\}$$

$$\xi_{il} \sim N(0, \lambda_l), \hspace{0.5cm} \lambda_l = 0.5^{l-1}, l=1,2, 3, 4$$

# Results

## Figure

```{r}
pred_list_allM[[1]] %>%
  filter(visit %in% 2:3 & id %in% 101:104) %>%
  mutate(eta_pred_J2 = ifelse(visit==1|(visit==2&t<=0.5), NA, eta_pred_J2)) %>%
  mutate(eta_pred_J3 = ifelse(visit==1|visit==2|(visit==3&t<=0.5), NA,
                              eta_pred_J3)) %>%
  mutate(eta_pred_J3 = exp(eta_pred_J3)/(1+exp(eta_pred_J3)),
         eta_pred_J2 = exp(eta_pred_J2)/(1+exp(eta_pred_J2))) %>% 
  ggplot()+
  geom_line(aes(x=t, y=probs, col="True"))+
  geom_line(aes(x=t, y=eta_pred_J2, col = "Visit 2"), linetype="dashed", 
            na.rm = T)+
  geom_line(aes(x=t, y=eta_pred_J3, col = "Visit 3"), linetype="dashed", 
            na.rm = T)+
  geom_point(aes(x=t, y=Y), size = 0.5)+
  facet_grid(row = vars(id), col=vars(visit))+
  labs(title = "gmFPCA")
```


```{r}
pred_list_allM_ref[[1]] %>%
  filter(visit %in% 2:3 & id %in% 101:104) %>%
  mutate(eta_pred_J2 = ifelse(visit==1|(visit==2&t<=0.5), NA, eta_pred_J2)) %>%
  mutate(eta_pred_J3 = ifelse(visit==1|visit==2|(visit==3&t<=0.5), NA,
                              eta_pred_J3)) %>%
  mutate(eta_pred_J3 = exp(eta_pred_J3)/(1+exp(eta_pred_J3)),
         eta_pred_J2 = exp(eta_pred_J2)/(1+exp(eta_pred_J2)), 
         eta = exp(eta)/(1+exp(eta))) %>% 
  ggplot()+
  geom_line(aes(x=t, y=eta, col="True"))+
  geom_line(aes(x=t, y=eta_pred_J2, col = "Visit 2"), linetype="dashed", 
            na.rm = T)+
  geom_line(aes(x=t, y=eta_pred_J3, col = "Visit 3"), linetype="dashed", 
            na.rm = T)+
  geom_point(aes(x=t, y=Y), size = 0.5)+
  facet_grid(row = vars(id), col=vars(visit))+
  labs(title = "GLMMadaptive")
```

# Computation time

```{r}
# print("Computation time:")
data.frame("gmFPCA" = c(mean(fit_time_vec), 
                        mean(pred_time_vec)),
           "GLMMadaptive" = c(mean(fit_time_vec_ref),
                              mean(pred_time_vec_ref))) %>% 
  mutate("Time (mins)" = c("Fit", "Prediction"), .before=1) %>%
  kable(digits = 2) %>% 
  kable_styling(full_width = F)



```


# Integerated squared error

- Over the entire prediction window

```{r, message=FALSE}
ise_J3 <- bind_rows(pred_list_allM, .id = "iter") %>% 
  filter(visit==3 & t> 0.5) %>%
  group_by(iter, id) %>% 
  mutate(error = (eta_pred_J3-eta)^2) %>%
  summarise(error = sum(error)) %>% 
  group_by(iter) %>%
  summarize(error = mean(error)) %>%
  summarize(error = mean(error), .groups = "drop") %>% unlist()

ise_J2 <- bind_rows(pred_list_allM, .id = "iter") %>% 
  filter((visit==3)|(visit==2 & t>0.5))%>%
  group_by(iter, id) %>% 
  mutate(error = (eta_pred_J2-eta)^2) %>%
  summarise(error = sum(error)) %>% 
  group_by(iter) %>% 
  summarize(error = mean(error)) %>% 
  summarize(error = mean(error), .groups = "drop") %>% unlist()


ise_J3_ref <- bind_rows(pred_list_allM_ref, .id = "iter") %>% 
  filter(visit==3 & t> 0.5) %>%
  group_by(iter, id) %>% 
  mutate(error = (eta_pred_J3-eta)^2) %>%
  summarise(error = sum(error)) %>% 
  group_by(iter) %>%
  summarize(error = mean(error)) %>%
  summarize(error = mean(error), .groups = "drop") %>% unlist()

ise_J2_ref <- bind_rows(pred_list_allM_ref, .id = "iter") %>% 
  filter((visit==3)|(visit==2 & t>0.5))%>%
  group_by(iter, id) %>% 
  mutate(error = (eta_pred_J2-eta)^2) %>%
  summarise(error = sum(error)) %>% 
  group_by(iter) %>% 
  summarize(error = mean(error)) %>% 
  summarize(error = mean(error), .groups = "drop") %>% unlist()
```

```{r}
# print("Integrated squared error:")
data.frame("gmFPCA" = c(ise_J2, ise_J3),
           "GLMMadaptive" = c(ise_J2_ref, ise_J3_ref)) %>% 
  mutate("Prediciton window" = c("Visit 2, t=0.5 to Visit 3, t=1", "Visit 3, t=0.5 to visit 3, t=1"), .before=1) %>%
  kable(digits = 2) %>% 
  kable_styling(full_width = F)
```

